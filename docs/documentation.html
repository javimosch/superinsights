<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SuperInsights Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      /* Minimal, self-contained Markdown styling (Tailwind Typography plugin is not available via CDN). */
      #content {
        color: hsl(var(--bc));
      }

      #content :is(h1, h2, h3, h4) {
        scroll-margin-top: 5rem;
      }

      #content h1 {
        font-size: 1.875rem;
        line-height: 2.25rem;
        font-weight: 700;
        margin: 0 0 1rem;
      }
      #content h2 {
        font-size: 1.5rem;
        line-height: 2rem;
        font-weight: 700;
        margin: 2rem 0 0.75rem;
        padding-bottom: 0.35rem;
        border-bottom: 1px solid hsl(var(--bc) / 0.15);
      }
      #content h3 {
        font-size: 1.25rem;
        line-height: 1.75rem;
        font-weight: 700;
        margin: 1.5rem 0 0.5rem;
      }
      #content h4 {
        font-size: 1.125rem;
        line-height: 1.75rem;
        font-weight: 700;
        margin: 1.25rem 0 0.35rem;
      }

      #content p {
        margin: 0.75rem 0;
      }

      #content :is(ul, ol) {
        margin: 0.75rem 0;
        padding-left: 1.25rem;
      }

      #content li {
        margin: 0.25rem 0;
      }

      #content a {
        color: hsl(var(--p));
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      #content a:hover {
        opacity: 0.9;
      }

      #content :is(code, kbd) {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-size: 0.9em;
        background: hsl(var(--b2));
        padding: 0.15rem 0.35rem;
        border-radius: 0.35rem;
      }

      #content pre {
        margin: 1rem 0;
        padding: 0.9rem;
        border-radius: 0.75rem;
        background: hsl(var(--b2));
        border: 1px solid hsl(var(--bc) / 0.12);
        overflow: auto;
      }

      #content pre code {
        background: transparent;
        padding: 0;
      }

      #content blockquote {
        margin: 1rem 0;
        padding: 0.75rem 1rem;
        border-left: 4px solid hsl(var(--p));
        background: hsl(var(--b2));
        border-radius: 0.5rem;
      }

      #content hr {
        margin: 1.5rem 0;
        border-color: hsl(var(--bc) / 0.15);
      }

      #content table {
        width: 100%;
        margin: 1rem 0;
        border-collapse: collapse;
        display: block;
        overflow-x: auto;
      }

      #content :is(th, td) {
        border: 1px solid hsl(var(--bc) / 0.12);
        padding: 0.5rem 0.65rem;
        vertical-align: top;
      }

      #content th {
        background: hsl(var(--b2));
        font-weight: 700;
      }

      #content img {
        max-width: 100%;
        border-radius: 0.75rem;
        border: 1px solid hsl(var(--bc) / 0.12);
      }

      #content .heading-anchor {
        text-decoration: none;
        opacity: 0;
        margin-left: 0.35rem;
        font-weight: 400;
        color: hsl(var(--bc) / 0.65);
      }

      #content :is(h1, h2, h3, h4):hover .heading-anchor {
        opacity: 1;
      }
    </style>
  </head>
  <body class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 shadow">
      <div class="navbar-start">
        <a class="btn btn-ghost text-xl" href="./index.html">SuperInsights</a>
      </div>
      <div class="navbar-center hidden md:flex">
        <div class="text-sm text-base-content/70">Documentation</div>
      </div>
      <div class="navbar-end">
        <a class="btn btn-primary" href="./documentation.html">Docs</a>
      </div>
    </div>

    <main class="container mx-auto p-4 grid gap-4 md:grid-cols-12">
      <aside class="md:col-span-3">
        <div class="card bg-base-100 shadow">
          <div class="card-body p-4">
            <div class="form-control">
              <label class="label" for="search">
                <span class="label-text">Search</span>
              </label>
              <input id="search" class="input input-bordered" placeholder="Filter features..." />
            </div>

            <div class="divider my-3"></div>

            <nav>
              <ul id="nav" class="menu bg-base-100 rounded-box"></ul>
            </nav>
          </div>
        </div>
      </aside>

      <section class="md:col-span-9">
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <div class="flex items-center justify-between gap-2">
              <h1 id="docTitle" class="text-2xl font-bold">Documentation</h1>
              <a id="viewSource" class="btn btn-ghost btn-sm" href="#" target="_blank" rel="noreferrer">View source</a>
            </div>
            <div id="status" class="text-sm text-base-content/60"></div>
            <div class="divider"></div>
            <article id="content" class="max-w-none"></article>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function () {
        marked.setOptions({
          gfm: true,
          breaks: false,
          headerIds: true,
          mangle: false,
        });

        const DOCS = [
          // Getting started
          { id: 'installation', title: 'Installation', path: './installation.md', section: 'Getting started' },
          { id: 'getting-started', title: 'Getting started', path: './getting-started.md', section: 'Getting started' },
          { id: 'configuration', title: 'Configuration', path: './configuration.md', section: 'Getting started' },
          { id: 'deployment', title: 'Deployment', path: './deployment.md', section: 'Getting started' },

          // Features
          { id: 'analytics-dashboard', title: 'Analytics dashboard', path: './features/analytics-dashboard.md', section: 'Features' },
          { id: 'analytics-pageviews', title: 'Page views analytics', path: './features/analytics-pageviews.md', section: 'Features' },
          { id: 'analytics-events', title: 'Events analytics', path: './features/analytics-events.md', section: 'Features' },
          { id: 'analytics-errors', title: 'Error tracking', path: './features/analytics-errors.md', section: 'Features' },
          { id: 'analytics-performance', title: 'Performance metrics', path: './features/analytics-performance.md', section: 'Features' },
          { id: 'public-links', title: 'Public project links', path: './features/public-links.md', section: 'Features' },
          { id: 'ai-analysis', title: 'AI Analysis', path: './features/ai-analysis.md', section: 'Features' },
          { id: 'sdk-tracking', title: 'SDK tracking (timing)', path: './features/sdk-tracking.md', section: 'Features' },
          { id: 'external-app-integration', title: 'External app integration', path: './features/external-app-integration.md', section: 'Features' },
        ];

        const navEl = document.getElementById('nav');
        const statusEl = document.getElementById('status');
        const contentEl = document.getElementById('content');
        const titleEl = document.getElementById('docTitle');
        const viewSourceEl = document.getElementById('viewSource');
        const searchEl = document.getElementById('search');

        const docIndex = new Map();
        let indexReady = false;
        let indexPromise = null;

        function getFeatureFromHash() {
          const hash = String(window.location.hash || '').replace(/^#/, '');
          if (!hash) return null;

          const params = new URLSearchParams(hash);
          const id = params.get('feature');
          return id || null;
        }

        function setHashFeature(id) {
          const params = new URLSearchParams();
          params.set('feature', id);
          window.location.hash = params.toString();
        }

        function renderNav(items) {
          navEl.innerHTML = '';

          const active = getFeatureFromHash() || 'getting-started';

          const grouped = new Map();
          for (const d of items) {
            const key = d.section || 'Docs';
            if (!grouped.has(key)) grouped.set(key, []);
            grouped.get(key).push(d);
          }

          const orderedSections = ['Getting started', 'Features'];
          const sections = Array.from(grouped.keys()).sort((a, b) => {
            const ai = orderedSections.indexOf(a);
            const bi = orderedSections.indexOf(b);
            if (ai !== -1 && bi !== -1) return ai - bi;
            if (ai !== -1) return -1;
            if (bi !== -1) return 1;
            return a.localeCompare(b);
          });

          for (const section of sections) {
            const headerLi = document.createElement('li');
            headerLi.className = 'menu-title';
            const span = document.createElement('span');
            span.textContent = section;
            headerLi.appendChild(span);
            navEl.appendChild(headerLi);

            const docs = grouped.get(section) || [];
            docs.sort((a, b) => a.title.localeCompare(b.title));

            for (const d of docs) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.href = `#feature=${encodeURIComponent(d.id)}`;
              a.textContent = d.title;
              if (d.id === active) {
                a.className = 'active';
              }
              a.addEventListener('click', (e) => {
                e.preventDefault();
                setHashFeature(d.id);
                loadFromHash();
              });
              li.appendChild(a);
              navEl.appendChild(li);
            }
          }
        }

        async function loadMarkdown(feature) {
          statusEl.textContent = 'Loading...';
          contentEl.innerHTML = '';
          titleEl.textContent = feature.title;
          viewSourceEl.href = feature.path;

          try {
            const resp = await fetch(feature.path, { cache: 'no-store' });
            if (!resp.ok) {
              statusEl.textContent = `Failed to load ${feature.path}`;
              return;
            }
            const md = await resp.text();
            statusEl.textContent = '';
            contentEl.innerHTML = marked.parse(md);
            postProcessRenderedContent();
          } catch (e) {
            statusEl.textContent = 'Failed to load documentation (fetch error).';
          }
        }

        async function ensureIndexLoaded() {
          if (indexReady) return;
          if (indexPromise) return indexPromise;

          indexPromise = (async () => {
            const tasks = DOCS.map(async (d) => {
              try {
                const resp = await fetch(d.path, { cache: 'no-store' });
                if (!resp.ok) {
                  docIndex.set(d.id, { title: d.title, section: d.section || 'Docs', path: d.path, body: '' });
                  return;
                }
                const body = await resp.text();
                docIndex.set(d.id, { title: d.title, section: d.section || 'Docs', path: d.path, body: String(body || '') });
              } catch (e) {
                docIndex.set(d.id, { title: d.title, section: d.section || 'Docs', path: d.path, body: '' });
              }
            });

            await Promise.all(tasks);
            indexReady = true;
          })();

          return indexPromise;
        }

        function postProcessRenderedContent() {
          // External links: open in new tab + safe rel.
          const links = contentEl.querySelectorAll('a[href]');
          for (const a of links) {
            const href = a.getAttribute('href');
            if (!href) continue;

            // Keep same-page anchors and relative links as-is.
            const isAnchor = href.startsWith('#');
            const isRelative = href.startsWith('./') || href.startsWith('../') || href.startsWith('/');
            if (isAnchor || isRelative) continue;

            a.setAttribute('target', '_blank');
            a.setAttribute('rel', 'noreferrer noopener');
          }

          // Add hoverable anchor links to headings that have ids.
          const headings = contentEl.querySelectorAll('h1[id], h2[id], h3[id], h4[id]');
          for (const h of headings) {
            // Avoid duplicate anchors if re-rendered.
            if (h.querySelector('.heading-anchor')) continue;

            const id = h.getAttribute('id');
            if (!id) continue;

            const anchor = document.createElement('a');
            anchor.className = 'heading-anchor';
            anchor.href = `#${encodeURIComponent(id)}`;
            anchor.textContent = '#';
            h.appendChild(anchor);
          }
        }

        function loadFromHash() {
          const id = getFeatureFromHash() || 'getting-started';
          const feature = DOCS.find((f) => f.id === id) || DOCS[0];

          // keep nav active state updated
          renderNav(filterFeatures(searchEl.value));
          loadMarkdown(feature);
        }

        function filterFeatures(query) {
          const q = (query || '').trim().toLowerCase();
          if (!q) return DOCS;

          const out = [];
          for (const d of DOCS) {
            const idx = docIndex.get(d.id);
            const body = idx && idx.body ? idx.body : '';
            const haystack = `${d.title}\n${d.id}\n${body}`.toLowerCase();
            if (haystack.includes(q)) out.push(d);
          }
          return out;
        }

        searchEl.addEventListener('input', async () => {
          await ensureIndexLoaded();
          const items = filterFeatures(searchEl.value);
          renderNav(items);
          statusEl.textContent = searchEl.value.trim() ? `Matches: ${items.length}` : '';
        });

        window.addEventListener('hashchange', () => {
          loadFromHash();
        });

        (async () => {
          await ensureIndexLoaded();
          renderNav(DOCS);
          loadFromHash();
        })();
      })();
    </script>
  </body>
</html>
