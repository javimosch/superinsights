<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  </head>
  <body class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 shadow">
      <div class="flex-1 px-4 flex items-center gap-4">
        <a href="/" class="text-xl font-bold">SuperInsights</a>
        <% if (currentUser) { %>
        <a href="/projects" class="btn btn-ghost btn-sm">Projects</a>
        <% if (currentUser.role === 'admin') { %>
        <a href="/admin/users" class="btn btn-ghost btn-sm">Users</a>
        <% } %>
        <% } %>
      </div>
      <div class="flex-none gap-2 px-4">
        <% if (currentUser) { %>
        <span class="text-sm mr-2">
          Signed in as <span class="font-semibold"><%= currentUser.email %></span>
          (<%= currentUser.role %>)
        </span>
        <form action="/auth/logout" method="POST">
          <button type="submit" class="btn btn-sm">Logout</button>
        </form>
        <% } else { %>
        <a href="/auth/login" class="btn btn-ghost btn-sm">Login</a>
        <a href="/auth/register" class="btn btn-primary btn-sm">Register</a>
        <% } %>
      </div>
    </div>

    <main id="app" class="container mx-auto p-4 space-y-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="text-3xl"><span>{{ project.icon || 'ðŸ“Š' }}</span></div>
          <div>
            <div class="breadcrumbs text-sm">
              <ul>
                <li><a href="/projects">Projects</a></li>
                <li>
                  <a :href="`/projects/${project._id}/settings`">{{ project.name }}</a>
                </li>
                <li>Dashboard</li>
              </ul>
            </div>
            <h1 class="text-2xl font-bold">Dashboard</h1>
            <p class="text-sm text-base-content/70">
              Environment: <span class="capitalize">{{ project.environment }}</span>
              â€¢ Role: <span class="capitalize">{{ currentProjectRole }}</span>
            </p>
          </div>
        </div>
        <div class="flex gap-2 flex-wrap">
          <a href="/projects/<%= project._id %>/dashboard" class="btn btn-primary">Dashboard</a>
          <a href="/projects/<%= project._id %>/pageviews" class="btn btn-ghost">Page Views</a>
          <a href="/projects/<%= project._id %>/events" class="btn btn-ghost">Events</a>
          <a href="/projects/<%= project._id %>/errors" class="btn btn-ghost">Errors</a>
          <a href="/projects/<%= project._id %>/performance" class="btn btn-ghost">Performance</a>
          <a :href="`/projects/${project._id}/settings`" class="btn btn-ghost">Back to settings</a>
        </div>
      </div>

      <section class="card bg-base-100 shadow">
        <div class="card-body space-y-4">
          <h2 class="card-title text-xl">Filters</h2>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="form-control">
              <label class="label" for="timeframe">
                <span class="label-text">Timeframe</span>
              </label>
              <select id="timeframe" v-model="timeframe" class="select select-bordered w-full">
                <option value="24h">Last 24 hours</option>
                <option value="7d">Last 7 days</option>
                <option value="30d">Last 30 days</option>
              </select>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Auto-refresh</span>
              </label>
              <div class="flex items-center gap-2">
                <input
                  type="checkbox"
                  class="toggle toggle-primary"
                  v-model="autoRefreshEnabled"
                />
                <span class="text-sm text-base-content/70">
                  Auto-refresh:
                  <span class="font-semibold">{{ autoRefreshEnabled ? 'ON' : 'OFF' }}</span>
                  <span v-if="autoRefreshEnabled">- Next update in {{ refreshCountdown }}s</span>
                </span>
              </div>
            </div>

            <div class="form-control md:col-span-2">
              <button type="button" class="btn btn-primary w-full" @click="applyFilters">Apply</button>
            </div>
          </div>
        </div>
      </section>

      <section class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <div class="stats shadow bg-base-100">
          <div class="stat">
            <div class="stat-title">Total page views</div>
            <div class="stat-value text-primary">{{ pageViewsData.totalViews || 0 }}</div>
            <div class="stat-desc">
              Unique visitors: <span class="font-semibold">{{ pageViewsData.uniqueVisitors || 0 }}</span>
            </div>
          </div>
        </div>

        <div class="stats shadow bg-base-100">
          <div class="stat">
            <div class="stat-title">Total events</div>
            <div class="stat-value">{{ eventsData.totalEvents || 0 }}</div>
            <div class="stat-desc">
              Top:
              <span class="font-semibold">
                {{ topEventLabel }}
              </span>
            </div>
          </div>
        </div>

        <div class="stats shadow bg-base-100">
          <div class="stat">
            <div class="stat-title">Total errors</div>
            <div class="stat-value" :class="(errorsData.totalErrors || 0) > 0 ? 'text-error' : ''">
              {{ errorsData.totalErrors || 0 }}
            </div>
            <div class="stat-desc">
              Unique fingerprints: <span class="font-semibold">{{ errorsData.uniqueFingerprints || 0 }}</span>
            </div>
          </div>
        </div>

        <div class="stats shadow bg-base-100">
          <div class="stat">
            <div class="stat-title">Performance score</div>
            <div class="stat-value">
              <span class="badge" :class="scoreBadgeClass">{{ performanceScoreValue }}</span>
            </div>
            <div class="stat-desc">Based on 75th percentiles</div>
          </div>
        </div>
      </section>

      <section class="grid gap-4 md:grid-cols-2">
        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Page Views Over Time</h2>
              <a href="/projects/<%= project._id %>/pageviews" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>
            <div v-if="!pageViewsData.viewsByDay || !pageViewsData.viewsByDay.length" class="py-10 text-center text-base-content/70">
              No page views yet.
              <div class="mt-2">
                <a href="/sdk/README.md" class="link">See SDK docs</a>
              </div>
            </div>
            <div v-else class="w-full h-72">
              <canvas id="pageViewsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Events Over Time</h2>
              <a href="/projects/<%= project._id %>/events" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>
            <div v-if="!eventsData.eventsByDay || !eventsData.eventsByDay.length" class="py-10 text-center text-base-content/70">
              No events yet.
              <div class="mt-2">
                <a href="/sdk/README.md" class="link">See SDK docs</a>
              </div>
            </div>
            <div v-else class="w-full h-72">
              <canvas id="eventsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Errors Over Time</h2>
              <a href="/projects/<%= project._id %>/errors" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>
            <div v-if="!errorsData.errorsByDay || !errorsData.errorsByDay.length" class="py-10 text-center text-base-content/70">
              No errors yet.
              <div class="mt-2">
                <a href="/sdk/README.md" class="link">See SDK docs</a>
              </div>
            </div>
            <div v-else class="w-full h-72">
              <canvas id="errorsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Core Web Vitals</h2>
              <a href="/projects/<%= project._id %>/performance" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>
            <div v-if="!performanceData.metricsByDay || !performanceData.metricsByDay.length" class="py-10 text-center text-base-content/70">
              No performance measurements yet.
              <div class="mt-2">
                <a href="/sdk/README.md" class="link">See SDK docs</a>
              </div>
            </div>
            <div v-else class="w-full h-72">
              <canvas id="performanceChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="grid gap-4 md:grid-cols-2">
        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Top Pages</h2>
              <a href="/projects/<%= project._id %>/pageviews" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>

            <div v-if="!pageViewsData.topPages || !pageViewsData.topPages.length" class="py-6 text-center text-base-content/70">
              No pages to show.
            </div>

            <div v-else class="overflow-x-auto">
              <table class="table table-zebra w-full text-sm">
                <thead>
                  <tr>
                    <th>URL</th>
                    <th class="text-right">Views</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in pageViewsData.topPages" :key="row.url">
                    <td class="max-w-[520px]">
                      <div class="truncate" :title="row.url">{{ row.url }}</div>
                    </td>
                    <td class="text-right">{{ row.views }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card bg-base-100 shadow">
          <div class="card-body space-y-4">
            <div class="flex items-center justify-between">
              <h2 class="card-title text-xl">Top Events</h2>
              <a href="/projects/<%= project._id %>/events" class="btn btn-ghost btn-sm">View Details â†’</a>
            </div>

            <div v-if="!eventsData.topEvents || !eventsData.topEvents.length" class="py-6 text-center text-base-content/70">
              No events to show.
            </div>

            <div v-else class="overflow-x-auto">
              <table class="table table-zebra w-full text-sm">
                <thead>
                  <tr>
                    <th>Event name</th>
                    <th class="text-right">Count</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in eventsData.topEvents" :key="row.eventName">
                    <td class="max-w-[520px]">
                      <div class="truncate" :title="row.eventName">{{ row.eventName }}</div>
                    </td>
                    <td class="text-right">{{ row.count }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <div v-if="fetchError" class="alert alert-error">
        <span class="text-sm">{{ fetchError }}</span>
      </div>
    </main>

    <script>
      const { createApp, computed, onBeforeUnmount, onMounted, ref, watch } = Vue;

      createApp({
        setup() {
          const project = ref(<%- JSON.stringify(project) %>);
          const currentProjectRole = '<%= currentProjectRole %>';

          const timeframe = ref('<%= timeframe %>');

          const pageViewsData = ref(<%- JSON.stringify(pageViews || {}) %>);
          const eventsData = ref(<%- JSON.stringify(events || {}) %>);
          const errorsData = ref(<%- JSON.stringify(errors || {}) %>);
          const performanceData = ref(<%- JSON.stringify(performance || {}) %>);

          const autoRefreshEnabled = ref(true);
          const refreshCountdown = ref(30);
          let refreshInterval = null;
          let countdownInterval = null;

          const fetchError = ref('');
          let consecutiveFetchFailures = 0;

          let pageViewsChart = null;
          let eventsChart = null;
          let errorsChart = null;
          let performanceChart = null;

          const topEventLabel = computed(() => {
            const first = (eventsData.value && eventsData.value.topEvents && eventsData.value.topEvents[0]) || null;
            return first && first.eventName ? first.eventName : 'â€”';
          });

          const performanceScoreValue = computed(() => {
            const score = Number(performanceData.value?.performanceScore?.score) || 0;
            return score;
          });

          const scoreBadgeClass = computed(() => {
            const score = performanceScoreValue.value;
            if (score > 75) return 'badge-success';
            if (score >= 50) return 'badge-warning';
            return 'badge-error';
          });

          function destroyCharts() {
            if (pageViewsChart) pageViewsChart.destroy();
            if (eventsChart) eventsChart.destroy();
            if (errorsChart) errorsChart.destroy();
            if (performanceChart) performanceChart.destroy();
            pageViewsChart = null;
            eventsChart = null;
            errorsChart = null;
            performanceChart = null;
          }

          function renderCharts() {
            try {
              destroyCharts();

              if (pageViewsData.value?.viewsByDay?.length) {
                const el = document.getElementById('pageViewsChart');
                if (el) {
                  const labels = pageViewsData.value.viewsByDay.map((p) => p.date);
                  const data = pageViewsData.value.viewsByDay.map((p) => p.count);
                  pageViewsChart = new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        {
                          label: 'Page views',
                          data,
                          borderColor: '#3b82f6',
                          backgroundColor: 'rgba(59, 130, 246, 0.15)',
                          fill: true,
                          tension: 0.25,
                          pointRadius: 3,
                        },
                      ],
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                      },
                      scales: {
                        x: { ticks: { maxRotation: 0 }, grid: { display: false } },
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                      },
                    },
                  });
                }
              }

              if (eventsData.value?.eventsByDay?.length) {
                const el = document.getElementById('eventsChart');
                if (el) {
                  const labels = eventsData.value.eventsByDay.map((p) => p.date);
                  const data = eventsData.value.eventsByDay.map((p) => p.count);
                  eventsChart = new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        {
                          label: 'Events',
                          data,
                          borderColor: '#8b5cf6',
                          backgroundColor: 'rgba(139, 92, 246, 0.15)',
                          fill: true,
                          tension: 0.25,
                          pointRadius: 3,
                        },
                      ],
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                      },
                      scales: {
                        x: { ticks: { maxRotation: 0 }, grid: { display: false } },
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                      },
                    },
                  });
                }
              }

              if (errorsData.value?.errorsByDay?.length) {
                const el = document.getElementById('errorsChart');
                if (el) {
                  const labels = errorsData.value.errorsByDay.map((p) => p.date);
                  const data = errorsData.value.errorsByDay.map((p) => p.count);
                  errorsChart = new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        {
                          label: 'Errors',
                          data,
                          borderColor: '#ef4444',
                          backgroundColor: 'rgba(239, 68, 68, 0.12)',
                          fill: true,
                          tension: 0.25,
                          pointRadius: 3,
                        },
                      ],
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                      },
                      scales: {
                        x: { ticks: { maxRotation: 0 }, grid: { display: false } },
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                      },
                    },
                  });
                }
              }

              if (performanceData.value?.metricsByDay?.length) {
                const el = document.getElementById('performanceChart');
                if (el) {
                  const labels = performanceData.value.metricsByDay.map((p) => p.date);

                  const lcp = performanceData.value.metricsByDay.map((p) => p.lcp);
                  const cls = performanceData.value.metricsByDay.map((p) => p.cls);
                  const fid = performanceData.value.metricsByDay.map((p) => p.fid);
                  const ttfb = performanceData.value.metricsByDay.map((p) => p.ttfb);

                  performanceChart = new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: {
                      labels,
                      datasets: [
                        {
                          label: 'LCP',
                          data: lcp,
                          borderColor: '#3b82f6',
                          backgroundColor: 'rgba(59, 130, 246, 0.08)',
                          tension: 0.25,
                          pointRadius: 2,
                        },
                        {
                          label: 'CLS',
                          data: cls,
                          borderColor: '#22c55e',
                          backgroundColor: 'rgba(34, 197, 94, 0.08)',
                          tension: 0.25,
                          pointRadius: 2,
                        },
                        {
                          label: 'FID',
                          data: fid,
                          borderColor: '#eab308',
                          backgroundColor: 'rgba(234, 179, 8, 0.08)',
                          tension: 0.25,
                          pointRadius: 2,
                        },
                        {
                          label: 'TTFB',
                          data: ttfb,
                          borderColor: '#f97316',
                          backgroundColor: 'rgba(249, 115, 22, 0.08)',
                          tension: 0.25,
                          pointRadius: 2,
                        },
                      ],
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: { display: true },
                        tooltip: {
                          enabled: true,
                          callbacks: {
                            label(context) {
                              const label = context.dataset.label || '';
                              const value = context.parsed.y;
                              if (label === 'CLS') {
                                return `${label}: ${typeof value === 'number' ? value.toFixed(3) : value}`;
                              }
                              return `${label}: ${typeof value === 'number' ? Math.round(value) : value} ms`;
                            },
                          },
                        },
                      },
                      scales: {
                        x: { ticks: { maxRotation: 0 }, grid: { display: false } },
                        y: { beginAtZero: true },
                      },
                    },
                  });
                }
              }
            } catch (err) {
              console.error('Chart rendering failed:', err);
            }
          }

          async function fetchDashboardData() {
            try {
              fetchError.value = '';

              const response = await fetch(
                `/projects/${project.value._id}/dashboard/data?timeframe=${encodeURIComponent(timeframe.value)}`
              );
              const result = await response.json();

              if (result && result.success) {
                pageViewsData.value = result.data.pageViews;
                eventsData.value = result.data.events;
                errorsData.value = result.data.errors;
                performanceData.value = result.data.performance;

                consecutiveFetchFailures = 0;
                renderCharts();
                return;
              }

              consecutiveFetchFailures += 1;
              fetchError.value = 'Failed to refresh dashboard data.';
            } catch (error) {
              console.error('Failed to fetch dashboard data:', error);
              consecutiveFetchFailures += 1;
              fetchError.value = 'Failed to refresh dashboard data.';
            }

            if (consecutiveFetchFailures >= 3) {
              autoRefreshEnabled.value = false;
              stopAutoRefresh();
              fetchError.value = 'Auto-refresh disabled after repeated failures.';
            }
          }

          function startAutoRefresh() {
            if (!autoRefreshEnabled.value) return;

            stopAutoRefresh();

            refreshInterval = setInterval(() => {
              fetchDashboardData();
              refreshCountdown.value = 30;
            }, 30000);

            countdownInterval = setInterval(() => {
              if (refreshCountdown.value > 0) {
                refreshCountdown.value--;
              }
            }, 1000);
          }

          function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            refreshInterval = null;
            countdownInterval = null;
          }

          watch(
            autoRefreshEnabled,
            (enabled) => {
              if (enabled) {
                refreshCountdown.value = 30;
                startAutoRefresh();
              } else {
                stopAutoRefresh();
              }
            },
            { flush: 'post' }
          );

          function applyFilters() {
            const params = new URLSearchParams();
            if (timeframe.value) params.set('timeframe', timeframe.value);

            const base = `/projects/${project.value._id}/dashboard`;
            const query = params.toString();
            window.location.href = query ? `${base}?${query}` : base;
          }

          onMounted(() => {
            renderCharts();
            if (autoRefreshEnabled.value) {
              startAutoRefresh();
            }
          });

          onBeforeUnmount(() => {
            stopAutoRefresh();
            destroyCharts();
          });

          return {
            project,
            currentProjectRole,
            timeframe,
            pageViewsData,
            eventsData,
            errorsData,
            performanceData,
            autoRefreshEnabled,
            refreshCountdown,
            fetchError,
            topEventLabel,
            performanceScoreValue,
            scoreBadgeClass,
            renderCharts,
            fetchDashboardData,
            startAutoRefresh,
            stopAutoRefresh,
            applyFilters,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
