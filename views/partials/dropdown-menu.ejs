<!-- Dropdown Menu - Reusable context and action menus -->
<!-- Enhanced with icons, keyboard navigation, and dynamic positioning -->
<div id="dropdown-menu" class="fixed z-50 hidden" role="menu" aria-orientation="vertical">
  <div class="menu bg-base-100 rounded-box shadow-xl border border-base-300 min-w-[200px] max-w-[300px] p-2">
    <!-- Menu items will be dynamically inserted here -->
  </div>
</div>

<!-- Backdrop for closing dropdown on outside click -->
<div id="dropdown-menu-backdrop" class="fixed inset-0 z-40 hidden" aria-hidden="true"></div>

<style>
  /* Dropdown menu animations */
  @keyframes dropdownSlideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes dropdownSlideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes dropdownFadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  #dropdown-menu.dropdown-menu-show {
    display: block !important;
  }

  #dropdown-menu.dropdown-menu-show.position-bottom {
    animation: dropdownSlideDown 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  #dropdown-menu.dropdown-menu-show.position-top {
    animation: dropdownSlideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  #dropdown-menu.dropdown-menu-hiding {
    animation: dropdownFadeOut 0.15s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  /* Menu item styles */
  .dropdown-menu-item {
    @apply flex items-center gap-3 px-3 py-2 rounded-btn cursor-pointer transition-colors;
  }

  .dropdown-menu-item:hover:not(.dropdown-menu-disabled) {
    @apply bg-base-200;
  }

  .dropdown-menu-item:focus {
    @apply bg-base-200 outline-none;
  }

  .dropdown-menu-item.dropdown-menu-active {
    @apply bg-primary text-primary-content;
  }

  .dropdown-menu-item.dropdown-menu-disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .dropdown-menu-item.dropdown-menu-danger:hover:not(.dropdown-menu-disabled) {
    @apply bg-error text-error-content;
  }

  .dropdown-menu-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .dropdown-menu-label {
    @apply flex-1 text-sm font-medium;
  }

  .dropdown-menu-shortcut {
    @apply text-xs opacity-60 ml-auto;
  }

  .dropdown-menu-divider {
    @apply divider my-1;
  }

  .dropdown-menu-header {
    @apply px-3 py-2 text-xs font-semibold text-base-content/60 uppercase tracking-wider;
  }
</style>

<script>
/**
 * Dropdown Menu System
 * Provides context menus and action menus with keyboard navigation
 */
class DropdownMenu {
  constructor(menuId = 'dropdown-menu') {
    this.menu = document.getElementById(menuId);
    this.menuContent = this.menu.querySelector('.menu');
    this.backdrop = document.getElementById('dropdown-menu-backdrop');
    this.isVisible = false;
    this.currentTrigger = null;
    this.currentItems = [];
    this.focusedIndex = -1;
    this.currentPosition = 'bottom-right';

    this.setupEventListeners();
  }

  setupEventListeners() {
    // Close on backdrop click
    this.backdrop.addEventListener('click', () => {
      this.hide();
    });

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (!this.isVisible) return;

      if (e.key === 'Escape') {
        e.preventDefault();
        this.hide();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        this.focusNext();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        this.focusPrevious();
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.activateFocused();
      }
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (this.isVisible && !this.menu.contains(e.target) && e.target !== this.currentTrigger) {
        this.hide();
      }
    });
  }

  /**
   * Show the dropdown menu
   * @param {Object} options - Configuration options
   * @param {HTMLElement} options.trigger - Element that triggered the menu
   * @param {Array} options.items - Menu items array
   * @param {string} options.position - Position: 'bottom-right', 'bottom-left', 'top-right', 'top-left' (default: 'bottom-right')
   * @param {number} options.offsetX - Horizontal offset in pixels (default: 0)
   * @param {number} options.offsetY - Vertical offset in pixels (default: 4)
   */
  show(options = {}) {
    const {
      trigger = null,
      items = [],
      position = 'bottom-right',
      offsetX = 0,
      offsetY = 4
    } = options;

    if (!trigger || items.length === 0) {
      console.warn('DropdownMenu: trigger element and items are required');
      return;
    }

    this.currentTrigger = trigger;
    this.currentItems = items;
    this.currentPosition = position;
    this.focusedIndex = -1;

    // Build menu items
    this.buildMenu(items);

    // Position the menu
    this.positionMenu(trigger, position, offsetX, offsetY);

    // Show menu and backdrop
    this.backdrop.classList.remove('hidden');
    this.menu.classList.remove('dropdown-menu-hiding');
    this.menu.classList.add('dropdown-menu-show');
    
    // Add position class for animation
    const positionClass = position.includes('top') ? 'position-top' : 'position-bottom';
    this.menu.classList.add(positionClass);

    this.isVisible = true;

    // Set ARIA attributes
    this.menu.setAttribute('aria-hidden', 'false');
  }

  /**
   * Hide the dropdown menu
   */
  hide() {
    if (!this.isVisible) return;

    this.menu.classList.add('dropdown-menu-hiding');
    this.menu.classList.remove('dropdown-menu-show');

    setTimeout(() => {
      this.menu.classList.remove('dropdown-menu-hiding', 'position-top', 'position-bottom');
      this.menu.classList.add('hidden');
      this.backdrop.classList.add('hidden');
      this.menuContent.innerHTML = '';
      this.currentTrigger = null;
      this.currentItems = [];
      this.focusedIndex = -1;
      this.isVisible = false;

      // Reset ARIA attributes
      this.menu.setAttribute('aria-hidden', 'true');
    }, 150);
  }

  /**
   * Build menu items HTML
   * @param {Array} items - Menu items
   */
  buildMenu(items) {
    this.menuContent.innerHTML = '';

    items.forEach((item, index) => {
      if (item.type === 'divider') {
        const divider = document.createElement('div');
        divider.className = 'dropdown-menu-divider';
        this.menuContent.appendChild(divider);
      } else if (item.type === 'header') {
        const header = document.createElement('div');
        header.className = 'dropdown-menu-header';
        header.textContent = item.label || '';
        this.menuContent.appendChild(header);
      } else {
        const menuItem = document.createElement('div');
        menuItem.className = 'dropdown-menu-item';
        menuItem.setAttribute('role', 'menuitem');
        menuItem.setAttribute('tabindex', '-1');
        menuItem.dataset.index = index;

        if (item.disabled) {
          menuItem.classList.add('dropdown-menu-disabled');
          menuItem.setAttribute('aria-disabled', 'true');
        }

        if (item.active) {
          menuItem.classList.add('dropdown-menu-active');
        }

        if (item.danger) {
          menuItem.classList.add('dropdown-menu-danger');
        }

        // Icon
        if (item.icon) {
          const icon = document.createElement('img');
          icon.src = item.icon;
          icon.alt = '';
          icon.className = 'dropdown-menu-icon';
          menuItem.appendChild(icon);
        }

        // Label
        const label = document.createElement('span');
        label.className = 'dropdown-menu-label';
        label.textContent = item.label || '';
        menuItem.appendChild(label);

        // Shortcut
        if (item.shortcut) {
          const shortcut = document.createElement('span');
          shortcut.className = 'dropdown-menu-shortcut';
          shortcut.textContent = item.shortcut;
          menuItem.appendChild(shortcut);
        }

        // Click handler
        if (!item.disabled && item.onClick) {
          menuItem.addEventListener('click', (e) => {
            e.stopPropagation();
            item.onClick();
            this.hide();
          });
        }

        // Hover handler for focus
        menuItem.addEventListener('mouseenter', () => {
          this.setFocus(index);
        });

        this.menuContent.appendChild(menuItem);
      }
    });
  }

  /**
   * Position the menu relative to trigger element
   * @param {HTMLElement} trigger - Trigger element
   * @param {string} position - Position string
   * @param {number} offsetX - X offset
   * @param {number} offsetY - Y offset
   */
  positionMenu(trigger, position, offsetX, offsetY) {
    const triggerRect = trigger.getBoundingClientRect();
    const menuRect = this.menu.getBoundingClientRect();
    
    let top, left;

    // Calculate position
    if (position.includes('bottom')) {
      top = triggerRect.bottom + offsetY;
    } else {
      top = triggerRect.top - menuRect.height - offsetY;
    }

    if (position.includes('right')) {
      left = triggerRect.right - menuRect.width + offsetX;
    } else {
      left = triggerRect.left + offsetX;
    }

    // Ensure menu stays within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (left + menuRect.width > viewportWidth) {
      left = viewportWidth - menuRect.width - 8;
    }
    if (left < 8) {
      left = 8;
    }
    if (top + menuRect.height > viewportHeight) {
      top = viewportHeight - menuRect.height - 8;
    }
    if (top < 8) {
      top = 8;
    }

    this.menu.style.top = `${top}px`;
    this.menu.style.left = `${left}px`;
  }

  /**
   * Focus next menu item
   */
  focusNext() {
    const items = Array.from(this.menuContent.querySelectorAll('.dropdown-menu-item:not(.dropdown-menu-disabled)'));
    if (items.length === 0) return;

    this.focusedIndex = (this.focusedIndex + 1) % items.length;
    this.setFocus(parseInt(items[this.focusedIndex].dataset.index));
  }

  /**
   * Focus previous menu item
   */
  focusPrevious() {
    const items = Array.from(this.menuContent.querySelectorAll('.dropdown-menu-item:not(.dropdown-menu-disabled)'));
    if (items.length === 0) return;

    this.focusedIndex = this.focusedIndex <= 0 ? items.length - 1 : this.focusedIndex - 1;
    this.setFocus(parseInt(items[this.focusedIndex].dataset.index));
  }

  /**
   * Set focus to specific item
   * @param {number} index - Item index
   */
  setFocus(index) {
    const items = this.menuContent.querySelectorAll('.dropdown-menu-item');
    items.forEach((item, i) => {
      if (parseInt(item.dataset.index) === index) {
        item.focus();
        this.focusedIndex = i;
      }
    });
  }

  /**
   * Activate focused item
   */
  activateFocused() {
    const items = Array.from(this.menuContent.querySelectorAll('.dropdown-menu-item:not(.dropdown-menu-disabled)'));
    if (this.focusedIndex >= 0 && this.focusedIndex < items.length) {
      items[this.focusedIndex].click();
    }
  }
}

// Global dropdown menu instance
const dropdownMenu = new DropdownMenu();

// Make it globally available
window.showDropdownMenu = (options) => {
  dropdownMenu.show(options);
};

// Expose helper functions for console testing
window.dropdownTest = {
  /**
   * Show test dropdown menu
   * @param {HTMLElement} trigger - Trigger element (defaults to body)
   */
  show: function(trigger = document.body) {
    dropdownMenu.show({
      trigger: trigger,
      items: [
        { label: 'Profile', icon: '/icons/user.svg', onClick: () => console.log('Profile clicked') },
        { label: 'Settings', icon: '/icons/settings.svg', onClick: () => console.log('Settings clicked'), shortcut: '⌘,' },
        { type: 'divider' },
        { label: 'Logout', icon: '/icons/log-out.svg', onClick: () => console.log('Logout clicked'), danger: true }
      ],
      position: 'bottom-right'
    });
  },

  /**
   * Test with headers and sections
   */
  showGrouped: function(trigger = document.body) {
    dropdownMenu.show({
      trigger: trigger,
      items: [
        { type: 'header', label: 'Account' },
        { label: 'Profile', icon: '/icons/user.svg', onClick: () => console.log('Profile') },
        { label: 'Settings', icon: '/icons/settings.svg', onClick: () => console.log('Settings') },
        { type: 'divider' },
        { type: 'header', label: 'Actions' },
        { label: 'New Project', icon: '/icons/plus.svg', onClick: () => console.log('New Project') },
        { type: 'divider' },
        { label: 'Logout', icon: '/icons/log-out.svg', onClick: () => console.log('Logout'), danger: true }
      ]
    });
  },

  /**
   * Test different positions
   */
  testPositions: function(trigger = document.body) {
    const positions = ['bottom-right', 'bottom-left', 'top-right', 'top-left'];
    let index = 0;

    const showNext = () => {
      if (index >= positions.length) return;
      
      dropdownMenu.show({
        trigger: trigger,
        items: [
          { label: `Position: ${positions[index]}`, onClick: () => {} },
          { type: 'divider' },
          { label: 'Close', onClick: () => {} }
        ],
        position: positions[index]
      });

      setTimeout(() => {
        dropdownMenu.hide();
        index++;
        setTimeout(showNext, 500);
      }, 2000);
    };

    showNext();
  },

  /**
   * Help text
   */
  help: function() {
    console.log(`
Dropdown Menu Testing Helper - Available Commands:

  dropdownTest.show(trigger)
    Show basic dropdown menu
    Example: dropdownTest.show(document.querySelector('button'))

  dropdownTest.showGrouped(trigger)
    Show dropdown with headers and sections

  dropdownTest.testPositions(trigger)
    Cycle through all position options

  dropdownTest.help()
    Show this help message

Keyboard Navigation:
  ↑/↓ - Navigate items
  Enter/Space - Activate item
  Esc - Close menu
    `);
  }
};

// Print help message to console on page load
if (typeof console !== 'undefined') {
  console.log('%cDropdown Menu loaded!', 'color: #4CAF50; font-weight: bold;');
  console.log('Type `dropdownTest.help()` to see all available test functions');
}
</script>